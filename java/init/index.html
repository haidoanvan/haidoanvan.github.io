<!DOCTYPE html>
<html lang="en-us">
    <head>
		
		
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-133700000-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
			<meta name="description" content="How does the standard bridge for Optimism work? Why does it work this way?">

		<title>Optimism standard bridge contract walkthrough &middot; Home</title>

		
		<link rel="stylesheet" href="/css/style.css">
		<link rel="stylesheet" href="/css/fonts.css">
		
		<link rel="icon" href="/favicon.ico"/>
		<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

		
		<link href="" rel="alternate" type="application/rss+xml" title="Home" />
	</head>

    <body>
        		<nav class="nav">
			<div class="nav-container">
				<a href="/">
					
						<h2 class="nav-title">Home</h2>
					
				</a>
				<ul>
    
    
        <li>
            <a href="/blockchain/">
                
                <span>Blockchain</span>
                
            </a>
        </li>
    
        <li>
            <a href="/design-pattern/">
                
                <span>Design Pattern</span>
                
            </a>
        </li>
    
        <li>
            <a href="/java/">
                
                <span>Java</span>
                
            </a>
        </li>
    
</ul>
			</div>
		</nav>

        

<main>
	<div class="post">
		<div class="post-info">
    <span>Written by</span>
        Ori Pomerantz
        <br>
        <span>on&nbsp;</span><time datetime="2022-03-30 00:00:00 &#43;0000 UTC">March 30, 2022</time>
</div>

		<h1 class="post-title">Optimism standard bridge contract walkthrough</h1>
<div class="post-line"></div>

		

		<p><a href="https://www.optimism.io/">Optimism</a> is an <a href="/developers/docs/scaling/optimistic-rollups/">Optimistic Rollup</a>.
Optimistic rollups can process transactions for a much lower price than Ethereum Mainnet (also known as layer 1 or L1) because transactions are only processed by a few nodes, instead of every node on the network.
At the same time, the data is all written to L1 so everything can be proved and reconstructed with all the integrity and availability guarantees of Mainnet.</p>
<p>To use L1 assets on Optimism (or any other L2), the assets need to be <a href="/bridges/#prerequisites">bridged</a>.
One way to achieve this is for users to lock assets (ETH and <a href="https://ethereum.org/en/developers/docs/standards/tokens/erc-20/">ERC-20 tokens</a> are the most common ones) on L1, and receive equivalent assets to use on L2.
Eventually, whoever ends up with them might want to bridge them back to L1.
When doing this, the assets are burned on L2 and then released back to the user on L1.</p>
<p>This is the way the <a href="https://community.optimism.io/docs/developers/bridge/standard-bridge">Optimism standard bridge</a> works.
In this article we go over the source code for that bridge to see how it works and study it as an example of well written Solidity code.</p>
<h2 id="control-flows">Control flows</h2>
<p>The bridge has two main flows:</p>
<ul>
<li>Deposit (from L1 to L2)</li>
<li>Withdrawal (from L2 to L1)</li>
</ul>
<h3 id="deposit-flow">Deposit flow</h3>
<h4 id="deposit-flow-layer-1">Layer 1</h4>
<ol>
<li>If depositing an ERC-20, the depositor gives the bridge an allowance to spend the amount being deposited</li>
<li>The depositor calls the L1 bridge (<code>depositERC20</code>, <code>depositERC20To</code>, <code>depositETH</code>, or <code>depositETHTo</code>)</li>
<li>The L1 bridge takes possession of the bridged asset
<ul>
<li>ETH: The asset is transferred by the depositor as part of the call</li>
<li>ERC-20: The asset is transferred by the bridge to itself using the allowance provided by the depositor</li>
</ul>
</li>
<li>The L1 bridge uses the cross-domain message mechanism to call <code>finalizeDeposit</code> on the L2 bridge</li>
</ol>
<h4 id="deposit-flow-layer-2">Layer 2</h4>
<ol start="5">
<li>The L2 bridge verifies the call to <code>finalizeDeposit</code> is legitimate:
<ul>
<li>Came from the cross domain message contract</li>
<li>Was originally from the bridge on L1</li>
</ul>
</li>
<li>The L2 bridge checks if the ERC-20 token contract on L2 is the correct one:
<ul>
<li>The L2 contract reports that its L1 counterpart is the same as the one the tokens came from on L1</li>
<li>The L2 contract reports that it supports the correct interface (<a href="https://eips.ethereum.org/EIPS/eip-165">using ERC-165</a>).</li>
</ul>
</li>
<li>If the L2 contract is the correct one, call it to mint the appropriate number of tokens to the appropriate address. If not, start a withdrawal process to allow the user to claim the tokens on L1.</li>
</ol>
<h3 id="withdrawal-flow">Withdrawal flow</h3>
<h4 id="withdrawl-flow-layer-2">Layer 2</h4>
<ol>
<li>The withdrawer calls the L2 bridge (<code>withdraw</code> or <code>withdrawTo</code>)</li>
<li>The L2 bridge burns the appropriate number of tokens belonging to <code>msg.sender</code></li>
<li>The L2 bridge uses the cross-domain message mechanism to call <code>finalizeETHWithdrawal</code> or <code>finalizeERC20Withdrawal</code> on the L1 bridge</li>
</ol>
<h4 id="withdrawl-flow-layer-1">Layer 1</h4>
<ol start="4">
<li>The L1 bridge verifies the call to <code>finalizeETHWithdrawal</code> or <code>finalizeERC20Withdrawal</code> is legitimate:
<ul>
<li>Came from the cross domain message mechanism</li>
<li>Was originally from the bridge on L2</li>
</ul>
</li>
<li>The L1 bridge transfers the appropriate asset (ETH or ERC-20) to the appropriate address</li>
</ol>
<h2 id="layer-1-code">Layer 1 code</h2>
<p>This is the code that runs on L1, the Ethereum Mainnet.</p>
<h3 id="IL1ERC20Bridge">IL1ERC20Bridge</h3>
<p><a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts/contracts/L1/messaging/IL1ERC20Bridge.sol">This interface is defined here</a>.
It includes functions and definitions required for bridging ERC-20 tokens.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#75715e">// SPDX-License-Identifier: MIT
</span></span></span></code></pre></div><p><a href="https://help.optimism.io/hc/en-us/articles/4411908707995-What-software-license-does-Optimism-use-">Most of Optimism&rsquo;s code is released under the MIT license</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#66d9ef">pragma solidity</span> <span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">5</span>.<span style="color:#ae81ff">0</span> <span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">9</span>.<span style="color:#ae81ff">0</span>;
</span></span></code></pre></div><p>At writing the latest version of Solidity is 0.8.12.
Until version 0.9.0 is released, we don&rsquo;t know if this code is compatible with it or not.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @title IL1ERC20Bridge
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">IL1ERC20Bridge</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**********
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Events *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     **********/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">event</span> <span style="color:#a6e22e">ERC20DepositInitiated</span>(
</span></span></code></pre></div><p>In Optimism bridge terminology <em>deposit</em> means transfer from L1 to L2, and <em>withdrawal</em> means a transfer from L2 to L1.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> <span style="color:#66d9ef">indexed</span> _l1Token,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> <span style="color:#66d9ef">indexed</span> _l2Token,
</span></span></code></pre></div><p>In most cases the address of an ERC-20 on L1 is not the same the address of the equivalent ERC-20 on L2.
<a href="https://static.optimism.io/optimism.tokenlist.json">You can see the list of token addresses here</a>.
The address with <code>chainId</code> 1 is on L1 (Mainnet) and the address with <code>chainId</code> 10 is on L2 (Optimism).
The other two <code>chainId</code> values are for the Kovan test network (42) and the Optimistic Kovan test network (69).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> <span style="color:#66d9ef">indexed</span> _from,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _to,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint256</span> _amount,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bytes</span> _data
</span></span><span style="display:flex;"><span>    );
</span></span></code></pre></div><p>It is possible to add notes to transfers, in which case they are added to the events that report them.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>    <span style="color:#66d9ef">event</span> <span style="color:#a6e22e">ERC20WithdrawalFinalized</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> <span style="color:#66d9ef">indexed</span> _l1Token,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> <span style="color:#66d9ef">indexed</span> _l2Token,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> <span style="color:#66d9ef">indexed</span> _from,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _to,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint256</span> _amount,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bytes</span> _data
</span></span><span style="display:flex;"><span>    );
</span></span></code></pre></div><p>The same bridge contract handles transfers in both directions.
In the case of the L1 bridge, this means initialization of deposits and finalization of withdrawals.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/********************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Public Functions *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     ********************/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @dev get the address of the corresponding L2 bridge contract.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return Address of the corresponding L2 bridge contract.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">l2TokenBridge</span>() <span style="color:#66d9ef">external</span> <span style="color:#66d9ef">returns</span> (<span style="color:#66d9ef">address</span>);
</span></span></code></pre></div><p>This function is not really needed, because on L2 it is a predeployed contract, so it is always at address <code>0x4200000000000000000000000000000000000010</code>.
It is here for symmetry with the L2 bridge, because the address of the L1 bridge is <em>not</em> trivial to know.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @dev deposit an amount of the ERC20 to the caller&#39;s balance on L2.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _l1Token Address of the L1 ERC20 we are depositing
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _l2Token Address of the L1 respective L2 ERC20
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _amount Amount of the ERC20 to deposit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _l2Gas Gas limit required to complete the deposit on L2.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _data Optional data to forward to L2. This data is provided
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *        solely as a convenience for external contracts. Aside from enforcing a maximum
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *        length, these contracts provide no guarantees about its content.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">depositERC20</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _l1Token,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _l2Token,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint256</span> _amount,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint32</span> _l2Gas,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bytes</span> calldata _data
</span></span><span style="display:flex;"><span>    ) <span style="color:#66d9ef">external</span>;
</span></span></code></pre></div><p>The <code>_l2Gas</code> parameter is the amount of L2 gas the transaction is allowed to spend.
<a href="https://community.optimism.io/docs/developers/bridge/messaging/#for-l1-%E2%87%92-l2-transactions-2">Up to a certain (high) limit, this is free</a>, so unless the ERC-20 contract does something really strange when minting, it should not be an issue.
This function takes care of the common scenario, where a user bridges assets to the same address on a different blockchain.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @dev deposit an amount of ERC20 to a recipient&#39;s balance on L2.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _l1Token Address of the L1 ERC20 we are depositing
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _l2Token Address of the L1 respective L2 ERC20
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _to L2 address to credit the withdrawal to.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _amount Amount of the ERC20 to deposit.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _l2Gas Gas limit required to complete the deposit on L2.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _data Optional data to forward to L2. This data is provided
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *        solely as a convenience for external contracts. Aside from enforcing a maximum
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *        length, these contracts provide no guarantees about its content.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">depositERC20To</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _l1Token,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _l2Token,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _to,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint256</span> _amount,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint32</span> _l2Gas,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bytes</span> calldata _data
</span></span><span style="display:flex;"><span>    ) <span style="color:#66d9ef">external</span>;
</span></span></code></pre></div><p>This function is almost identical to <code>depositERC20</code>, but it lets you send the ERC-20 to a different address.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>    <span style="color:#75715e">/*************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Cross-chain Functions *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *************************/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @dev Complete a withdrawal from L2 to L1, and credit funds to the recipient&#39;s balance of the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * L1 ERC20 token.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * This call will fail if the initialized withdrawal from L2 has not been finalized.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _l1Token Address of L1 token to finalizeWithdrawal for.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _l2Token Address of L2 token where withdrawal was initiated.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _from L2 address initiating the transfer.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _to L1 address to credit the withdrawal to.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _amount Amount of the ERC20 to deposit.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _data Data provided by the sender on L2. This data is provided
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *   solely as a convenience for external contracts. Aside from enforcing a maximum
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *   length, these contracts provide no guarantees about its content.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">finalizeERC20Withdrawal</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _l1Token,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _l2Token,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _from,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _to,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint256</span> _amount,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bytes</span> calldata _data
</span></span><span style="display:flex;"><span>    ) <span style="color:#66d9ef">external</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Withdrawals (and other messages from L2 to L1) in Optimism are a two step process:</p>
<ol>
<li>An initiating transaction on L2.</li>
<li>A finalizing or claiming transaction on L1.
This transaction needs to happen after the <a href="https://community.optimism.io/docs/how-optimism-works/#fault-proofs">fault challenge period</a> for the L2 transaction ends.</li>
</ol>
<h3 id="il1standardbridge">IL1StandardBridge</h3>
<p><a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts/contracts/L1/messaging/IL1StandardBridge.sol">This interface is defined here</a>.
This file contains event and function definitions for ETH.
These definitions are very similar to those defined in <code>IL1ERC20Bridge</code> above for ERC-20.</p>
<p>The bridge interface is divided between two files because some ERC-20 tokens require custom processing and cannot be handled by the standard bridge.
This way the custom bridge that handles such a token can implement <code>IL1ERC20Bridge</code> and not have to also bridge ETH.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#75715e">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">pragma solidity</span> <span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">5</span>.<span style="color:#ae81ff">0</span> <span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">9</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;./IL1ERC20Bridge.sol&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @title IL1StandardBridge
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">IL1StandardBridge</span> <span style="color:#66d9ef">is</span> IL1ERC20Bridge {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**********
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Events *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     **********/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">event</span> <span style="color:#a6e22e">ETHDepositInitiated</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> <span style="color:#66d9ef">indexed</span> _from,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> <span style="color:#66d9ef">indexed</span> _to,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint256</span> _amount,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bytes</span> _data
</span></span><span style="display:flex;"><span>    );
</span></span></code></pre></div><p>This event is nearly identical to the ERC-20 version (<code>ERC20DepositInitiated</code>), except without the L1 and L2 token addresses.
The same is true for the other events and the functions.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>    <span style="color:#66d9ef">event</span> <span style="color:#a6e22e">ETHWithdrawalFinalized</span>(
</span></span><span style="display:flex;"><span>        .
</span></span><span style="display:flex;"><span>        .
</span></span><span style="display:flex;"><span>        .
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/********************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Public Functions *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     ********************/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @dev Deposit an amount of the ETH to the caller&#39;s balance on L2.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            .
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            .
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            .
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">depositETH</span>(<span style="color:#66d9ef">uint32</span> _l2Gas, <span style="color:#66d9ef">bytes</span> calldata _data) <span style="color:#66d9ef">external</span> <span style="color:#66d9ef">payable</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @dev Deposit an amount of ETH to a recipient&#39;s balance on L2.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            .
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            .
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            .
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">depositETHTo</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _to,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint32</span> _l2Gas,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bytes</span> calldata _data
</span></span><span style="display:flex;"><span>    ) <span style="color:#66d9ef">external</span> <span style="color:#66d9ef">payable</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Cross-chain Functions *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *************************/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @dev Complete a withdrawal from L2 to L1, and credit funds to the recipient&#39;s balance of the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * L1 ETH token. Since only the xDomainMessenger can call this function, it will never be called
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * before the withdrawal is finalized.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                .
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                .
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                .
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">finalizeETHWithdrawal</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _from,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _to,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint256</span> _amount,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bytes</span> calldata _data
</span></span><span style="display:flex;"><span>    ) <span style="color:#66d9ef">external</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="crossdomainenabled">CrossDomainEnabled</h3>
<p><a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts/contracts/libraries/bridge/CrossDomainEnabled.sol">This contract</a> is inherited by both bridges (<a href="#the-l1-bridge-contract">L1</a> and <a href="#the-l2-bridge-contract">L2</a>) to send messages to the other layer.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#75715e">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">pragma solidity</span> <span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">5</span>.<span style="color:#ae81ff">0</span> <span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">9</span>.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Interface Imports */</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> { ICrossDomainMessenger } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;./ICrossDomainMessenger.sol&#34;</span>;
</span></span></code></pre></div><p><a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts/contracts/libraries/bridge/ICrossDomainMessenger.sol">This interface</a> tells the contract how to send messages to the other layer, using the cross domain messenger.
This cross domain messenger is a whole other system, and deserves its own article, which I hope to write in the future.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @title CrossDomainEnabled
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @dev Helper contract for contracts performing cross-domain communications
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Compiler used: defined by inheriting contract
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">contract</span> <span style="color:#a6e22e">CrossDomainEnabled</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Variables *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *************/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Messenger contract used to send and receive messages from the other domain.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">address</span> <span style="color:#66d9ef">public</span> messenger;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/***************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Constructor *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     ***************/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _messenger Address of the CrossDomainMessenger on the current layer.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">constructor</span>(<span style="color:#66d9ef">address</span> _messenger) {
</span></span><span style="display:flex;"><span>        messenger <span style="color:#f92672">=</span> _messenger;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>The one parameter that the contract needs to know, the address of the cross domain messenger on this layer.
This parameter is set once, in the constructor, and never changes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**********************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Function Modifiers *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     **********************/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Enforces that the modified function is only callable by a specific cross-domain account.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _sourceDomainAccount The only account on the originating domain which is
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *  authenticated to call this function.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">modifier</span> <span style="color:#a6e22e">onlyFromCrossDomainAccount</span>(<span style="color:#66d9ef">address</span> _sourceDomainAccount) {
</span></span></code></pre></div><p>The cross domain messaging is accessible by any contract on the blockchain where it is running (either Ethereum mainnet or Optimism).
But we need the bridge on each side to <em>only</em> trust certain messages if they come from the bridge on the other side.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>        require(
</span></span><span style="display:flex;"><span>            msg.sender <span style="color:#f92672">==</span> <span style="color:#66d9ef">address</span>(getCrossDomainMessenger()),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;OVM_XCHAIN: messenger contract unauthenticated&#34;</span>
</span></span><span style="display:flex;"><span>        );
</span></span></code></pre></div><p>Only messages from the appropriate cross domain messenger (<code>messenger</code>, as you see below) can be trusted.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        require(
</span></span><span style="display:flex;"><span>            getCrossDomainMessenger().xDomainMessageSender() <span style="color:#f92672">==</span> _sourceDomainAccount,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;OVM_XCHAIN: wrong sender of cross-domain message&#34;</span>
</span></span><span style="display:flex;"><span>        );
</span></span></code></pre></div><p>The way the cross domain messenger provides the address that sent a message with the other layer is <a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts/contracts/L1/messaging/L1CrossDomainMessenger.sol#L122-L128">the <code>.xDomainMessageSender()</code> function</a>.
As long as it is called in the transaction that was initiated by the message it can provide this information.</p>
<p>We need to make sure that the message we received came from the other bridge.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">_</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**********************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Internal Functions *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     **********************/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Gets the messenger, usually from storage. This function is exposed in case a child contract
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * needs to override.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return The address of the cross-domain messenger contract which should be used.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getCrossDomainMessenger</span>() <span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">returns</span> (ICrossDomainMessenger) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ICrossDomainMessenger(messenger);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>This function returns the cross domain messenger.
We use a function rather than the variable <code>messenger</code> to allow contracts that inherit from this one to use an algorithm to specify which cross domain messenger to use.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Sends a message to an account on another domain
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _crossDomainTarget The intended recipient on the destination domain
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _message The data to send to the target (usually calldata to a function with
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *  `onlyFromCrossDomainAccount()`)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _gasLimit The gasLimit for the receipt of the message on the target domain.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">sendCrossDomainMessage</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _crossDomainTarget,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint32</span> _gasLimit,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bytes</span> <span style="color:#66d9ef">memory</span> _message
</span></span></code></pre></div><p>Finally, the function that sends a message to the other layer.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>    ) <span style="color:#66d9ef">internal</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// slither-disable-next-line reentrancy-events, reentrancy-benign
</span></span></span></code></pre></div><p><a href="https://github.com/crytic/slither">Slither</a> is a static analyzer Optimism runs on every contract to look for vulnerabilities and other potential problems.
In this case, the following line triggers two vulnerabilities:</p>
<ol>
<li><a href="https://github.com/crytic/slither/wiki/Detector-Documentation#reentrancy-vulnerabilities-3">Reentrancy events</a></li>
<li><a href="https://github.com/crytic/slither/wiki/Detector-Documentation#reentrancy-vulnerabilities-2">Benign reentrancy</a></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>        getCrossDomainMessenger().sendMessage(_crossDomainTarget, _message, _gasLimit);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>In this case we are not worried about reentrancy we know <code>getCrossDomainMessenger()</code> returns a trustworthy address, even if Slither has no way to know that.</p>
<h3 id="the-l1-bridge-contract">The L1 bridge contract</h3>
<p><a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts/contracts/L1/messaging/L1StandardBridge.sol">The source code for this contract is here</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#75715e">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">pragma solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">8</span>.<span style="color:#ae81ff">9</span>;
</span></span></code></pre></div><p>The interfaces can be part of other contracts, so they have to support a wide range of Solidity versions.
But the bridge itself is our contract, and we can be strict about what Solidity version it uses.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#75715e">/* Interface Imports */</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> { IL1StandardBridge } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;./IL1StandardBridge.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> { IL1ERC20Bridge } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;./IL1ERC20Bridge.sol&#34;</span>;
</span></span></code></pre></div><p><a href="#IL1ERC20Bridge">IL1ERC20Bridge</a> and <a href="#IL1StandardBridge">IL1StandardBridge</a> are explained above.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#f92672">import</span> { IL2ERC20Bridge } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;../../L2/messaging/IL2ERC20Bridge.sol&#34;</span>;
</span></span></code></pre></div><p><a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts/contracts/L2/messaging/IL2ERC20Bridge.sol">This interface</a> lets us create messages to control the standard bridge on L2.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#f92672">import</span> { IERC20 } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;@openzeppelin/contracts/token/ERC20/IERC20.sol&#34;</span>;
</span></span></code></pre></div><p><a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/IERC20.sol">This interface</a> lets us control ERC-20 contracts.
<a href="/developers/tutorials/erc20-annotated-code/#the-interface">You can read more about it here</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#75715e">/* Library Imports */</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> { CrossDomainEnabled } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;../../libraries/bridge/CrossDomainEnabled.sol&#34;</span>;
</span></span></code></pre></div><p><a href="#crossdomainenabled">As explained above</a>, this contract is used for interlayer messaging.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#f92672">import</span> { Lib_PredeployAddresses } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;../../libraries/constants/Lib_PredeployAddresses.sol&#34;</span>;
</span></span></code></pre></div><p><a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts/contracts/libraries/constants/Lib_PredeployAddresses.sol"><code>Lib_PredeployAddresses</code></a> has the addresses for the L2 contracts that always have the same address. This includes the standard bridge on L2.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#f92672">import</span> { Address } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;@openzeppelin/contracts/utils/Address.sol&#34;</span>;
</span></span></code></pre></div><p><a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/Address.sol">OpenZeppelin&rsquo;s Address utilities</a>. It is used to distinguish between contract addresses and those belonging to externally owned accounts (EOA).</p>
<p>Note that this isn&rsquo;t a perfect solution, because there is no way to distinguish between direct calls and calls made from a contract&rsquo;s constructor, but at least this lets us identify and prevent some common user errors.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#f92672">import</span> { SafeERC20 } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol&#34;</span>;
</span></span></code></pre></div><p><a href="https://eips.ethereum.org/EIPS/eip-20">The ERC-20 standard</a> supports two ways for a contract to report failure:</p>
<ol>
<li>Revert</li>
<li>Return <code>false</code></li>
</ol>
<p>Handling both cases would make our code more complicated, so instead we use <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/utils/SafeERC20.sol">OpenZeppelin&rsquo;s <code>SafeERC20</code></a>, which makes sure <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/utils/SafeERC20.sol#L96">all failures result in a revert</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @title L1StandardBridge
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @dev The L1 ETH and ERC20 Bridge is a contract which stores deposited L1 funds and standard
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * tokens that are in use on L2. It synchronizes a corresponding L2 Bridge, informing it of deposits
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * and listening to it for newly finalized withdrawals.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">contract</span> <span style="color:#a6e22e">L1StandardBridge</span> <span style="color:#66d9ef">is</span> IL1StandardBridge, CrossDomainEnabled {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">using</span> SafeERC20 <span style="color:#66d9ef">for</span> IERC20;
</span></span></code></pre></div><p>This line is how we specify to use the <code>SafeERC20</code> wrapper every time we use the <code>IERC20</code> interface.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/********************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * External Contract References *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     ********************************/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">address</span> <span style="color:#66d9ef">public</span> l2TokenBridge;
</span></span></code></pre></div><p>The address of <a href="#the-l2-bridge-contract">L2StandardBridge</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Maps L1 token to L2 token to balance of the L1 token deposited
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">mapping</span>(<span style="color:#66d9ef">address</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">mapping</span>(<span style="color:#66d9ef">address</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">uint256</span>)) <span style="color:#66d9ef">public</span> deposits;
</span></span></code></pre></div><p>A double <a href="https://www.tutorialspoint.com/solidity/solidity_mappings.htm">mapping</a> like this is the way you define a <a href="https://en.wikipedia.org/wiki/Sparse_matrix">two-dimensional sparse array</a>.
Values in this data structure are identified as <code>deposit[L1 token addr][L2 token addr]</code>.
The default value is zero.
Only cells that are set to a different value are written to storage.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/***************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Constructor *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     ***************/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// This contract lives behind a proxy, so the constructor parameters will go unused.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">constructor</span>() CrossDomainEnabled(<span style="color:#66d9ef">address</span>(<span style="color:#ae81ff">0</span>)) {}
</span></span></code></pre></div><p>To want to be able to upgrade this contract without having to copy all the variables in the storage.
To do that we use a <a href="https://docs.openzeppelin.com/contracts/3.x/api/proxy"><code>Proxy</code></a>, a contract that uses <a href="https://solidity-by-example.org/delegatecall/"><code>delegatecall</code></a> to transfer calls to a separate contact whose address is stored by the proxy contract (when you upgrade you tell the proxy to change that address).
When you use <code>delegatecall</code> the storage remains the storage of the <em>calling</em> contract, so the values of all the contract state variables are unaffected.</p>
<p>One effect of this pattern is that the storage of the contract that is the <em>called</em> of <code>delegatecall</code> is not used and therefore the constructor values passed to it do not matter.
This is the reason we can provide a nonsensical value to the <code>CrossDomainEnabled</code> constructor.
It is also the reason the initialization below is separate from the constructor.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>    <span style="color:#75715e">/******************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Initialization *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     ******************/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _l1messenger L1 Messenger address being used for cross-chain communications.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _l2TokenBridge L2 standard bridge address.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// slither-disable-next-line external-function
</span></span></span></code></pre></div><p>This <a href="https://github.com/crytic/slither/wiki/Detector-Documentation#public-function-that-could-be-declared-external">Slither test</a> identifies functions that are not called from the contract code and could therefore be declared <code>external</code> instead of <code>public</code>.
The gas cost of <code>external</code> functions can be lower, because they can be provided with parameters in the calldata.
Functions declared <code>public</code> have to be accessible from within the contract.
Contracts cannot modify their own calldata, so the parameters have to be in memory.
When such a function is called externally, it is necessary to copy the calldata to memory, which costs gas.
In this case the function is only called once, so the inefficiency does not matter to us.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">initialize</span>(<span style="color:#66d9ef">address</span> _l1messenger, <span style="color:#66d9ef">address</span> _l2TokenBridge) <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>        require(messenger <span style="color:#f92672">==</span> <span style="color:#66d9ef">address</span>(<span style="color:#ae81ff">0</span>), <span style="color:#e6db74">&#34;Contract has already been initialized.&#34;</span>);
</span></span></code></pre></div><p>The <code>initialize</code> function should only be called once.
If the address of either the L1 cross domain messenger or the L2 token bridge changes, we create a new proxy and a new bridge that calls it.
This is unlikely to happen except when the entire system is upgraded, a very rare occurrence.</p>
<p>Note that this function does not have any mechanism that restricts <em>who</em> can call it.
This means that in theory an attacker could wait until we deploy the proxy and the first version of the bridge and then <a href="https://solidity-by-example.org/hacks/front-running/">front-run</a> to get to the <code>initialize</code> function before the legitimate user does. But there are two methods to prevent this:</p>
<ol>
<li>If the contracts are deployed not directly by an EOA but <a href="https://medium.com/upstate-interactive/creating-a-contract-with-a-smart-contract-bdb67c5c8595">in a transaction that has another contract create them</a> the entire process can be atomic, and finish before any other transaction is executed.</li>
<li>If the legitimate call to <code>initialize</code> fails it is always possible to ignore the newly created proxy and bridge and create new ones.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>        messenger <span style="color:#f92672">=</span> _l1messenger;
</span></span><span style="display:flex;"><span>        l2TokenBridge <span style="color:#f92672">=</span> _l2TokenBridge;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>These are the two parameters that the bridge needs to know.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Depositing *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     **************/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/** @dev Modifier requiring sender to be EOA.  This check could be bypassed by a malicious
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *  contract via initcode, but it takes care of the user error we want to avoid.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">modifier</span> <span style="color:#a6e22e">onlyEOA</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Used to stop deposits from contracts (avoid accidentally lost tokens)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        require(<span style="color:#f92672">!</span>Address.isContract(msg.sender), <span style="color:#e6db74">&#34;Account not EOA&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">_</span>;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>This is the reason we needed OpenZeppelin&rsquo;s <code>Address</code> utilities.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @dev This function can be called with no data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * to deposit an amount of ETH to the caller&#39;s balance on L2.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Since the receive function doesn&#39;t take data, a conservative
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * default amount is forwarded to L2.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    receive() <span style="color:#66d9ef">external</span> <span style="color:#66d9ef">payable</span> onlyEOA {
</span></span><span style="display:flex;"><span>        _initiateETHDeposit(msg.sender, msg.sender, <span style="color:#ae81ff">200</span>_000, <span style="color:#66d9ef">bytes</span>(<span style="color:#e6db74">&#34;&#34;</span>));
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>This function exists for testing purposes.
Notice that it doesn&rsquo;t appear in the interface definitions - it isn&rsquo;t for normal use.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @inheritdoc IL1StandardBridge
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">depositETH</span>(<span style="color:#66d9ef">uint32</span> _l2Gas, <span style="color:#66d9ef">bytes</span> calldata _data) <span style="color:#66d9ef">external</span> <span style="color:#66d9ef">payable</span> onlyEOA {
</span></span><span style="display:flex;"><span>        _initiateETHDeposit(msg.sender, msg.sender, _l2Gas, _data);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @inheritdoc IL1StandardBridge
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">depositETHTo</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _to,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint32</span> _l2Gas,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bytes</span> calldata _data
</span></span><span style="display:flex;"><span>    ) <span style="color:#66d9ef">external</span> <span style="color:#66d9ef">payable</span> {
</span></span><span style="display:flex;"><span>        _initiateETHDeposit(msg.sender, _to, _l2Gas, _data);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>These two functions are wrappers around <code>_initiateETHDeposit</code>, the function that handles the actual ETH deposit.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @dev Performs the logic for deposits by storing the ETH and informing the L2 ETH Gateway of
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * the deposit.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _from Account to pull the deposit from on L1.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _to Account to give the deposit to on L2.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _l2Gas Gas limit required to complete the deposit on L2.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _data Optional data to forward to L2. This data is provided
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *        solely as a convenience for external contracts. Aside from enforcing a maximum
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *        length, these contracts provide no guarantees about its content.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_initiateETHDeposit</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _from,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _to,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint32</span> _l2Gas,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bytes</span> <span style="color:#66d9ef">memory</span> _data
</span></span><span style="display:flex;"><span>    ) <span style="color:#66d9ef">internal</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Construct calldata for finalizeDeposit call
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">bytes</span> <span style="color:#66d9ef">memory</span> message <span style="color:#f92672">=</span> abi.encodeWithSelector(
</span></span></code></pre></div><p>The way that cross domain messages work is that the destination contract is called with the message as its calldata.
Solidity contracts always interpret their calldata is accordance with
<a href="https://docs.soliditylang.org/en/v0.8.12/abi-spec.html">the ABI specifications</a>.
The Solidity function <a href="https://docs.soliditylang.org/en/v0.8.12/units-and-global-variables.html#abi-encoding-and-decoding-functions"><code>abi.encodeWithSelector</code></a> creates that calldata.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>            IL2ERC20Bridge.finalizeDeposit.selector,
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">address</span>(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>            Lib_PredeployAddresses.OVM_ETH,
</span></span><span style="display:flex;"><span>            _from,
</span></span><span style="display:flex;"><span>            _to,
</span></span><span style="display:flex;"><span>            msg.value,
</span></span><span style="display:flex;"><span>            _data
</span></span><span style="display:flex;"><span>        );
</span></span></code></pre></div><p>The message here is to call <a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts/contracts/L2/messaging/L2StandardBridge.sol#L141-L148">the <code>finalizeDeposit</code> function</a> with these parameters:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Value</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>_l1Token</td>
<td>address(0)</td>
<td>Special value to stand for ETH (which isn&rsquo;t an ERC-20 token) on L1</td>
</tr>
<tr>
<td>_l2Token</td>
<td>Lib_PredeployAddresses.OVM_ETH</td>
<td>The L2 contract that manages ETH on Optimism, <code>0xDeadDeAddeAddEAddeadDEaDDEAdDeaDDeAD0000</code> (this contract is for internal Optimism use only)</td>
</tr>
<tr>
<td>_from</td>
<td>_from</td>
<td>The address on L1 that sends the ETH</td>
</tr>
<tr>
<td>_to</td>
<td>_to</td>
<td>The address on L2 that receives the ETH</td>
</tr>
<tr>
<td>amount</td>
<td>msg.value</td>
<td>Amount of wei sent (which has already been sent to the bridge)</td>
</tr>
<tr>
<td>_data</td>
<td>_data</td>
<td>Additional date to attach to the deposit</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>        <span style="color:#75715e">// Send calldata into L2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// slither-disable-next-line reentrancy-events
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        sendCrossDomainMessage(l2TokenBridge, _l2Gas, message);
</span></span></code></pre></div><p>Send the message through the cross domain messenger.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>        <span style="color:#75715e">// slither-disable-next-line reentrancy-events
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        emit ETHDepositInitiated(_from, _to, msg.value, _data);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>Emit an event to inform any decentralized application that listens of this transfer.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @inheritdoc IL1ERC20Bridge
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">depositERC20</span>(
</span></span><span style="display:flex;"><span>		.
</span></span><span style="display:flex;"><span>		.
</span></span><span style="display:flex;"><span>		.
</span></span><span style="display:flex;"><span>    ) <span style="color:#66d9ef">external</span> <span style="color:#66d9ef">virtual</span> onlyEOA {
</span></span><span style="display:flex;"><span>        _initiateERC20Deposit(_l1Token, _l2Token, msg.sender, msg.sender, _amount, _l2Gas, _data);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @inheritdoc IL1ERC20Bridge
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">depositERC20To</span>(
</span></span><span style="display:flex;"><span>		.
</span></span><span style="display:flex;"><span>		.
</span></span><span style="display:flex;"><span>		.
</span></span><span style="display:flex;"><span>    ) <span style="color:#66d9ef">external</span> <span style="color:#66d9ef">virtual</span> {
</span></span><span style="display:flex;"><span>        _initiateERC20Deposit(_l1Token, _l2Token, msg.sender, _to, _amount, _l2Gas, _data);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>These two functions are wrappers around <code>_initiateERC20Deposit</code>, the function that handles the actual ERC-20 deposit.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @dev Performs the logic for deposits by informing the L2 Deposited Token
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * contract of the deposit and calling a handler to lock the L1 funds. (e.g. transferFrom)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _l1Token Address of the L1 ERC20 we are depositing
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _l2Token Address of the L1 respective L2 ERC20
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _from Account to pull the deposit from on L1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _to Account to give the deposit to on L2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _amount Amount of the ERC20 to deposit.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _l2Gas Gas limit required to complete the deposit on L2.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _data Optional data to forward to L2. This data is provided
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *        solely as a convenience for external contracts. Aside from enforcing a maximum
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *        length, these contracts provide no guarantees about its content.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_initiateERC20Deposit</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _l1Token,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _l2Token,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _from,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _to,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint256</span> _amount,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint32</span> _l2Gas,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bytes</span> calldata _data
</span></span><span style="display:flex;"><span>    ) <span style="color:#66d9ef">internal</span> {
</span></span></code></pre></div><p>This function is similar to <code>_initiateETHDeposit</code> above, with a few important differences.
The first difference is that this function receives the token addresses and the amount to transfer as parameters.
In the case of ETH the call to the bridge already includes the transfer of asset to the bridge account (<code>msg.value</code>).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>        <span style="color:#75715e">// When a deposit is initiated on L1, the L1 Bridge transfers the funds to itself for future
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// withdrawals. safeTransferFrom also checks if the contract has code, so this will fail if
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// _from is an EOA or address(0).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// slither-disable-next-line reentrancy-events, reentrancy-benign
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        IERC20(_l1Token).safeTransferFrom(_from, <span style="color:#66d9ef">address</span>(this), _amount);
</span></span></code></pre></div><p>ERC-20 token transfers follow a different process from ETH:</p>
<ol>
<li>The user (<code>_from</code>) gives an allowance to the bridge to transfer the appropriate tokens.</li>
<li>The user calls the bridge with the address of the token contract, the amount, etc.</li>
<li>The bridge transfers the tokens (to itself) as part of the deposit process.</li>
</ol>
<p>The first step may happen in a separate transaction from the last two.
However, front-running is not a problem because the two functions that call <code>_initiateERC20Deposit</code> (<code>depositERC20</code> and <code>depositERC20To</code>) only call this function with <code>msg.sender</code> as the <code>_from</code> parameter.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>        <span style="color:#75715e">// Construct calldata for _l2Token.finalizeDeposit(_to, _amount)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">bytes</span> <span style="color:#66d9ef">memory</span> message <span style="color:#f92672">=</span> abi.encodeWithSelector(
</span></span><span style="display:flex;"><span>            IL2ERC20Bridge.finalizeDeposit.selector,
</span></span><span style="display:flex;"><span>            _l1Token,
</span></span><span style="display:flex;"><span>            _l2Token,
</span></span><span style="display:flex;"><span>            _from,
</span></span><span style="display:flex;"><span>            _to,
</span></span><span style="display:flex;"><span>            _amount,
</span></span><span style="display:flex;"><span>            _data
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Send calldata into L2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// slither-disable-next-line reentrancy-events, reentrancy-benign
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        sendCrossDomainMessage(l2TokenBridge, _l2Gas, message);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// slither-disable-next-line reentrancy-benign
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        deposits[_l1Token][_l2Token] <span style="color:#f92672">=</span> deposits[_l1Token][_l2Token] <span style="color:#f92672">+</span> _amount;
</span></span></code></pre></div><p>Add the deposited amount of tokens to the <code>deposits</code> data structure.
There could be multiple addresses on L2 that correspond to the same L1 ERC-20 token, so it is not sufficient to use the bridge&rsquo;s balance of the L1 ERC-20 token to keep track of deposits.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// slither-disable-next-line reentrancy-events
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        emit ERC20DepositInitiated(_l1Token, _l2Token, _from, _to, _amount, _data);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Cross-chain Functions *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *************************/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @inheritdoc IL1StandardBridge
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">finalizeETHWithdrawal</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _from,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _to,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint256</span> _amount,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bytes</span> calldata _data
</span></span></code></pre></div><p>The L2 bridge sends a message to the L2 cross domain messenger which causes the L1 cross domain messenger to call this function (once the <a href="https://community.optimism.io/docs/developers/bridge/messaging/#fees-for-l2-%E2%87%92-l1-transactions">transaction that finalizes the message</a> is submitted on L1, of course).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>    ) <span style="color:#66d9ef">external</span> onlyFromCrossDomainAccount(l2TokenBridge) {
</span></span></code></pre></div><p>Make sure that this is a <em>legitimate</em> message, coming from the cross domain messenger and originating with the L2 token bridge.
This function is used to withdraw ETH from the bridge, so we have to make sure it is only called by the authorized caller.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>        <span style="color:#75715e">// slither-disable-next-line reentrancy-events
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        (<span style="color:#66d9ef">bool</span> success, ) <span style="color:#f92672">=</span> _to.call{ value<span style="color:#f92672">:</span> _amount }(<span style="color:#66d9ef">new</span> <span style="color:#66d9ef">bytes</span>(<span style="color:#ae81ff">0</span>));
</span></span></code></pre></div><p>The way to transfer ETH is to call the recipient with the amount of wei in the <code>msg.value</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>        require(success, <span style="color:#e6db74">&#34;TransferHelper::safeTransferETH: ETH transfer failed&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// slither-disable-next-line reentrancy-events
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        emit ETHWithdrawalFinalized(_from, _to, _amount, _data);
</span></span></code></pre></div><p>Emit an event about the withdrawal.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @inheritdoc IL1ERC20Bridge
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">finalizeERC20Withdrawal</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _l1Token,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _l2Token,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _from,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _to,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint256</span> _amount,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bytes</span> calldata _data
</span></span><span style="display:flex;"><span>    ) <span style="color:#66d9ef">external</span> onlyFromCrossDomainAccount(l2TokenBridge) {
</span></span></code></pre></div><p>This function is similar to <code>finalizeETHWithdrawal</code> above, with the necessary changes for ERC-20 tokens.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>        deposits[_l1Token][_l2Token] <span style="color:#f92672">=</span> deposits[_l1Token][_l2Token] <span style="color:#f92672">-</span> _amount;
</span></span></code></pre></div><p>Update the <code>deposits</code> data structure.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// When a withdrawal is finalized on L1, the L1 Bridge transfers the funds to the withdrawer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// slither-disable-next-line reentrancy-events
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        IERC20(_l1Token).safeTransfer(_to, _amount);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// slither-disable-next-line reentrancy-events
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        emit ERC20WithdrawalFinalized(_l1Token, _l2Token, _from, _to, _amount, _data);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*****************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Temporary - Migrating ETH *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *****************************/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @dev Adds ETH balance to the account. This is meant to allow for ETH
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * to be migrated from an old gateway to a new gateway.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * NOTE: This is left for one upgrade only so we are able to receive the migrated ETH from the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * old contract
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">donateETH</span>() <span style="color:#66d9ef">external</span> <span style="color:#66d9ef">payable</span> {}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>There was an earlier implementation of the bridge.
When we moved from the implementation to this one, we had to move all the assets.
ERC-20 tokens can just be moved.
However, to transfer ETH to a contract you need that contract&rsquo;s approval, which is what <code>donateETH</code> provides us.</p>
<h2 id="erc-20-tokens-on-l2">ERC-20 Tokens on L2</h2>
<p>For an ERC-20 token to fit into the standard bridge, it needs to allow the standard bridge, and <em>only</em> the standard bridge, to mint token.
This is necessary because the bridges need to ensure that the number of tokens circulating on Optimism is equal to the number of tokens locked inside the L1 bridge contract.
If there are too many tokens on L2 some users would be unable to bridge their assets back to L1.
Instead of a trusted bridge, we would essentially recreate <a href="https://www.investopedia.com/terms/f/fractionalreservebanking.asp">fractional reserve banking</a>.
If there are too many tokens on L1, some of those tokens would stay locked inside the bridge contract forever because there is no way to release them without burning L2 tokens.</p>
<h3 id="il2standarderc20">IL2StandardERC20</h3>
<p>Every ERC-20 token on L2 that uses the standard bridge needs to provide <a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts/contracts/standards/IL2StandardERC20.sol">this interface</a>, which has the functions and events that the standard bridge needs.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#75715e">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">pragma solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">8</span>.<span style="color:#ae81ff">9</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> { IERC20 } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;@openzeppelin/contracts/token/ERC20/IERC20.sol&#34;</span>;
</span></span></code></pre></div><p><a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/IERC20.sol">The standard ERC-20 interface</a> does not include the <code>mint</code> and <code>burn</code> functions.
Those methods are not required by <a href="https://eips.ethereum.org/EIPS/eip-20">the ERC-20 standard</a>, which leaves unspecified the mechanisms to create and destroy tokens.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#f92672">import</span> { IERC165 } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;@openzeppelin/contracts/utils/introspection/IERC165.sol&#34;</span>;
</span></span></code></pre></div><p><a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/introspection/IERC165.sol">The ERC-165 interface</a> is used to specify what functions a contract provides.
<a href="https://eips.ethereum.org/EIPS/eip-165">You can read the standard here</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">IL2StandardERC20</span> <span style="color:#66d9ef">is</span> IERC20, IERC165 {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">l1Token</span>() <span style="color:#66d9ef">external</span> <span style="color:#66d9ef">returns</span> (<span style="color:#66d9ef">address</span>);
</span></span></code></pre></div><p>This function provides the address of the L1 token which is bridged to this contract.
Note that we do not have a similar function in the opposite direction.
We need to be able to bridge any L1 token, regardless of whether L2 support was planned when it was implemented or not.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">mint</span>(<span style="color:#66d9ef">address</span> _to, <span style="color:#66d9ef">uint256</span> _amount) <span style="color:#66d9ef">external</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">burn</span>(<span style="color:#66d9ef">address</span> _from, <span style="color:#66d9ef">uint256</span> _amount) <span style="color:#66d9ef">external</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">event</span> <span style="color:#a6e22e">Mint</span>(<span style="color:#66d9ef">address</span> <span style="color:#66d9ef">indexed</span> _account, <span style="color:#66d9ef">uint256</span> _amount);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">event</span> <span style="color:#a6e22e">Burn</span>(<span style="color:#66d9ef">address</span> <span style="color:#66d9ef">indexed</span> _account, <span style="color:#66d9ef">uint256</span> _amount);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Functions and events to mint (create) and burn (destroy) tokens.
The bridge should be the only entity that can run these functions to ensure the number of tokens is correct (equal to the number of tokens locked on L1).</p>
<h3 id="L2StandardERC20">L2StandardERC20</h3>
<p><a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts/contracts/standards/L2StandardERC20.sol">This is our implementation of the <code>IL2StandardERC20</code> interface</a>.
Unless you need some kind of custom logic, you should use this one.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#75715e">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">pragma solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">8</span>.<span style="color:#ae81ff">9</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> { ERC20 } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;@openzeppelin/contracts/token/ERC20/ERC20.sol&#34;</span>;
</span></span></code></pre></div><p><a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/ERC20.sol">The OpenZeppelin ERC-20 contract</a>.
Optimism does not believe in reinventing the wheel, especially when the wheel is well audited and needs to be trustworthy enough to hold assets.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;./IL2StandardERC20.sol&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">contract</span> <span style="color:#a6e22e">L2StandardERC20</span> <span style="color:#66d9ef">is</span> IL2StandardERC20, ERC20 {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">address</span> <span style="color:#66d9ef">public</span> l1Token;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">address</span> <span style="color:#66d9ef">public</span> l2Bridge;
</span></span></code></pre></div><p>These are the two additional configuration parameters that we require and ERC-20 normally does not.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _l2Bridge Address of the L2 standard bridge.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _l1Token Address of the corresponding L1 token.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _name ERC20 name.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _symbol ERC20 symbol.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">constructor</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _l2Bridge,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _l1Token,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">string</span> <span style="color:#66d9ef">memory</span> _name,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">string</span> <span style="color:#66d9ef">memory</span> _symbol
</span></span><span style="display:flex;"><span>    ) ERC20(_name, _symbol) {
</span></span><span style="display:flex;"><span>        l1Token <span style="color:#f92672">=</span> _l1Token;
</span></span><span style="display:flex;"><span>        l2Bridge <span style="color:#f92672">=</span> _l2Bridge;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>First call the constructor for the contract we inherit from (<code>ERC20(_name, _symbol)</code>) and then set our own variables.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">modifier</span> <span style="color:#a6e22e">onlyL2Bridge</span>() {
</span></span><span style="display:flex;"><span>        require(msg.sender <span style="color:#f92672">==</span> l2Bridge, <span style="color:#e6db74">&#34;Only L2 Bridge can mint and burn&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">_</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// slither-disable-next-line external-function
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">supportsInterface</span>(<span style="color:#66d9ef">bytes4</span> _interfaceId) <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">pure</span> <span style="color:#66d9ef">returns</span> (<span style="color:#66d9ef">bool</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bytes4</span> firstSupportedInterface <span style="color:#f92672">=</span> <span style="color:#66d9ef">bytes4</span>(keccak256(<span style="color:#e6db74">&#34;supportsInterface(bytes4)&#34;</span>)); <span style="color:#75715e">// ERC165
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">bytes4</span> secondSupportedInterface <span style="color:#f92672">=</span> IL2StandardERC20.l1Token.selector <span style="color:#f92672">^</span>
</span></span><span style="display:flex;"><span>            IL2StandardERC20.mint.selector <span style="color:#f92672">^</span>
</span></span><span style="display:flex;"><span>            IL2StandardERC20.burn.selector;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> _interfaceId <span style="color:#f92672">==</span> firstSupportedInterface <span style="color:#f92672">||</span> _interfaceId <span style="color:#f92672">==</span> secondSupportedInterface;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>This is the way <a href="https://eips.ethereum.org/EIPS/eip-165">ERC-165</a> works.
Every interface is a number of supported functions, and is identified as the <a href="https://en.wikipedia.org/wiki/Exclusive_or">exclusive or</a> of the <a href="https://docs.soliditylang.org/en/v0.8.12/abi-spec.html#function-selector">ABI function selectors</a> of those functions.</p>
<p>The L2 bridge uses ERC-165 as a sanity check to make sure that the ERC-20 contract to which it sends assets is an <code>IL2StandardERC20</code>.</p>
<p><strong>Note:</strong> There is nothing to prevent rogue contract from providing false answers to <code>supportsInterface</code>, so this is a sanity check mechanism, <em>not</em> a security mechanism.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>    <span style="color:#75715e">// slither-disable-next-line external-function
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">mint</span>(<span style="color:#66d9ef">address</span> _to, <span style="color:#66d9ef">uint256</span> _amount) <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">virtual</span> onlyL2Bridge {
</span></span><span style="display:flex;"><span>        _mint(_to, _amount);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        emit Mint(_to, _amount);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// slither-disable-next-line external-function
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">burn</span>(<span style="color:#66d9ef">address</span> _from, <span style="color:#66d9ef">uint256</span> _amount) <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">virtual</span> onlyL2Bridge {
</span></span><span style="display:flex;"><span>        _burn(_from, _amount);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        emit Burn(_from, _amount);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Only the L2 bridge is allowed to mint and burn assets.</p>
<p><code>_mint</code> and <code>_burn</code> are actually defined in the <a href="https://ethereum.org/en/developers/tutorials/erc20-annotated-code/#the-_mint-and-_burn-functions-_mint-and-_burn">OpenZeppelin ERC-20 contract</a>.
That contract just doesn&rsquo;t expose them externally, because the conditions to mint and burn tokens are as varied as the number of ways to use ERC-20.</p>
<h2 id="l2-bridge-code">L2 Bridge Code</h2>
<p>This is code that runs the bridge on Optimism.
<a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts/contracts/L2/messaging/L2StandardBridge.sol">The source for this contract is here</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#75715e">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">pragma solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">8</span>.<span style="color:#ae81ff">9</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Interface Imports */</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> { IL1StandardBridge } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;../../L1/messaging/IL1StandardBridge.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> { IL1ERC20Bridge } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;../../L1/messaging/IL1ERC20Bridge.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> { IL2ERC20Bridge } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;./IL2ERC20Bridge.sol&#34;</span>;
</span></span></code></pre></div><p>The <a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts/contracts/L2/messaging/IL2ERC20Bridge.sol">IL2ERC20Bridge</a> interface is very similar to the <a href="#IL1ERC20Bridge">L1 equivalent</a> we saw above.
There are two significant differences:</p>
<ol>
<li>On L1 you initiate deposits and finalize withdrawals.
Here you initiate withdrawals and finalize deposits.</li>
<li>On L1 it is necessary to distinguish between ETH and ERC-20 tokens.
On L2 we can use the same functions for both because internally ETH balances on Optimism are handled as an ERC-20 token with the address <a href="https://optimistic.etherscan.io/address/0xDeadDeAddeAddEAddeadDEaDDEAdDeaDDeAD0000">0xDeadDeAddeAddEAddeadDEaDDEAdDeaDDeAD0000</a>.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#75715e">/* Library Imports */</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> { ERC165Checker } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;@openzeppelin/contracts/utils/introspection/ERC165Checker.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> { CrossDomainEnabled } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;../../libraries/bridge/CrossDomainEnabled.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> { Lib_PredeployAddresses } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;../../libraries/constants/Lib_PredeployAddresses.sol&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Contract Imports */</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> { IL2StandardERC20 } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;../../standards/IL2StandardERC20.sol&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @title L2StandardBridge
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @dev The L2 Standard bridge is a contract which works together with the L1 Standard bridge to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * enable ETH and ERC20 transitions between L1 and L2.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * This contract acts as a minter for new tokens when it hears about deposits into the L1 Standard
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * bridge.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * This contract also acts as a burner of the tokens intended for withdrawal, informing the L1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * bridge to release L1 funds.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">contract</span> <span style="color:#a6e22e">L2StandardBridge</span> <span style="color:#66d9ef">is</span> IL2ERC20Bridge, CrossDomainEnabled {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/********************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * External Contract References *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     ********************************/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">address</span> <span style="color:#66d9ef">public</span> l1TokenBridge;
</span></span></code></pre></div><p>Keep track of the address of the L1 bridge.
Note that in contrast to the L1 equivalent, here we <em>need</em> this variable.
The address of the L1 bridge is not known in advance.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/***************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Constructor *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     ***************/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _l2CrossDomainMessenger Cross-domain messenger used by this contract.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _l1TokenBridge Address of the L1 bridge deployed to the main chain.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">constructor</span>(<span style="color:#66d9ef">address</span> _l2CrossDomainMessenger, <span style="color:#66d9ef">address</span> _l1TokenBridge)
</span></span><span style="display:flex;"><span>        CrossDomainEnabled(_l2CrossDomainMessenger)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        l1TokenBridge <span style="color:#f92672">=</span> _l1TokenBridge;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/***************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Withdrawing *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     ***************/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @inheritdoc IL2ERC20Bridge
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">withdraw</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _l2Token,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint256</span> _amount,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint32</span> _l1Gas,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bytes</span> calldata _data
</span></span><span style="display:flex;"><span>    ) <span style="color:#66d9ef">external</span> <span style="color:#66d9ef">virtual</span> {
</span></span><span style="display:flex;"><span>        _initiateWithdrawal(_l2Token, msg.sender, msg.sender, _amount, _l1Gas, _data);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @inheritdoc IL2ERC20Bridge
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">withdrawTo</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _l2Token,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _to,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint256</span> _amount,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint32</span> _l1Gas,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bytes</span> calldata _data
</span></span><span style="display:flex;"><span>    ) <span style="color:#66d9ef">external</span> <span style="color:#66d9ef">virtual</span> {
</span></span><span style="display:flex;"><span>        _initiateWithdrawal(_l2Token, msg.sender, _to, _amount, _l1Gas, _data);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>These two functions initiate withdrawals.
Note that there is no needs to specify the L1 token address.
L2 tokens are expected to tell us the L1 equivalent&rsquo;s address.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @dev Performs the logic for withdrawals by burning the token and informing
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *      the L1 token Gateway of the withdrawal.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _l2Token Address of L2 token where withdrawal is initiated.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _from Account to pull the withdrawal from on L2.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _to Account to give the withdrawal to on L1.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _amount Amount of the token to withdraw.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _l1Gas Unused, but included for potential forward compatibility considerations.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param _data Optional data to forward to L1. This data is provided
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *        solely as a convenience for external contracts. Aside from enforcing a maximum
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *        length, these contracts provide no guarantees about its content.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_initiateWithdrawal</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _l2Token,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _from,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _to,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint256</span> _amount,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint32</span> _l1Gas,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bytes</span> calldata _data
</span></span><span style="display:flex;"><span>    ) <span style="color:#66d9ef">internal</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// When a withdrawal is initiated, we burn the withdrawer&#39;s funds to prevent subsequent L2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// usage
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// slither-disable-next-line reentrancy-events
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        IL2StandardERC20(_l2Token).burn(msg.sender, _amount);
</span></span></code></pre></div><p>Notice that we are <em>not</em> relying on the <code>_from</code> parameter but on <code>msg.sender</code> which is a lot harder to fake (impossible, as far as I know).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Construct calldata for l1TokenBridge.finalizeERC20Withdrawal(_to, _amount)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// slither-disable-next-line reentrancy-events
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">address</span> l1Token <span style="color:#f92672">=</span> IL2StandardERC20(_l2Token).l1Token();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bytes</span> <span style="color:#66d9ef">memory</span> message;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (_l2Token <span style="color:#f92672">==</span> Lib_PredeployAddresses.OVM_ETH) {
</span></span></code></pre></div><p>On L1 it is necessary to distinguish between ETH and ERC-20.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>            message <span style="color:#f92672">=</span> abi.encodeWithSelector(
</span></span><span style="display:flex;"><span>                IL1StandardBridge.finalizeETHWithdrawal.selector,
</span></span><span style="display:flex;"><span>                _from,
</span></span><span style="display:flex;"><span>                _to,
</span></span><span style="display:flex;"><span>                _amount,
</span></span><span style="display:flex;"><span>                _data
</span></span><span style="display:flex;"><span>            );
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            message <span style="color:#f92672">=</span> abi.encodeWithSelector(
</span></span><span style="display:flex;"><span>                IL1ERC20Bridge.finalizeERC20Withdrawal.selector,
</span></span><span style="display:flex;"><span>                l1Token,
</span></span><span style="display:flex;"><span>                _l2Token,
</span></span><span style="display:flex;"><span>                _from,
</span></span><span style="display:flex;"><span>                _to,
</span></span><span style="display:flex;"><span>                _amount,
</span></span><span style="display:flex;"><span>                _data
</span></span><span style="display:flex;"><span>            );
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Send message up to L1 bridge
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// slither-disable-next-line reentrancy-events
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        sendCrossDomainMessage(l1TokenBridge, _l1Gas, message);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// slither-disable-next-line reentrancy-events
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        emit WithdrawalInitiated(l1Token, _l2Token, msg.sender, _to, _amount, _data);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/************************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Cross-chain Function: Depositing *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     ************************************/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @inheritdoc IL2ERC20Bridge
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">finalizeDeposit</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _l1Token,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _l2Token,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _from,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">address</span> _to,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint256</span> _amount,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bytes</span> calldata _data
</span></span></code></pre></div><p>This function is called by <code>L1StandardBridge</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>    ) <span style="color:#66d9ef">external</span> <span style="color:#66d9ef">virtual</span> onlyFromCrossDomainAccount(l1TokenBridge) {
</span></span></code></pre></div><p>Make sure the source of the message is legitimate.
This is important because this function calls <code>_mint</code> and could be used to give tokens that are not covered by tokens the bridge owns on L1.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>        <span style="color:#75715e">// Check the target token is compliant and
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// verify the deposited token on L1 matches the L2 deposited token representation here
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// slither-disable-next-line reentrancy-events
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            ERC165Checker.supportsInterface(_l2Token, <span style="color:#ae81ff">0x1d1d8b63</span>) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>            _l1Token <span style="color:#f92672">==</span> IL2StandardERC20(_l2Token).l1Token()
</span></span></code></pre></div><p>Sanity checks:</p>
<ol>
<li>The correct interface is supported</li>
<li>The L2 ERC-20 contract&rsquo;s L1 address matches the L1 source of the tokens</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>        ) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// When a deposit is finalized, we credit the account on L2 with the same amount of
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// tokens.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// slither-disable-next-line reentrancy-events
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            IL2StandardERC20(_l2Token).mint(_to, _amount);
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// slither-disable-next-line reentrancy-events
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            emit DepositFinalized(_l1Token, _l2Token, _from, _to, _amount, _data);
</span></span></code></pre></div><p>If the sanity checks pass, finalize the deposit:</p>
<ol>
<li>Mint the tokens</li>
<li>Emit the appropriate event</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Either the L2 token which is being deposited-into disagrees about the correct address
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// of its L1 token, or does not support the correct interface.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// This should only happen if there is a  malicious L2 token, or if a user somehow
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// specified the wrong L2 token address to deposit into.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// In either case, we stop the process here and construct a withdrawal
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// message so that users can get their funds out in some cases.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// There is no way to prevent malicious token contracts altogether, but this does limit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// user error and mitigate some forms of malicious contract behavior.
</span></span></span></code></pre></div><p>If a user made a detectable error by using the wrong L2 token address, we want to cancel the deposit and return the tokens on L1.
The only way we can do this from L2 is to send a message that will have to wait the fault challenge period, but that is much better for the user than losing the tokens permanently.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>            <span style="color:#66d9ef">bytes</span> <span style="color:#66d9ef">memory</span> message <span style="color:#f92672">=</span> abi.encodeWithSelector(
</span></span><span style="display:flex;"><span>                IL1ERC20Bridge.finalizeERC20Withdrawal.selector,
</span></span><span style="display:flex;"><span>                _l1Token,
</span></span><span style="display:flex;"><span>                _l2Token,
</span></span><span style="display:flex;"><span>                _to, <span style="color:#75715e">// switched the _to and _from here to bounce back the deposit to the sender
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                _from,
</span></span><span style="display:flex;"><span>                _amount,
</span></span><span style="display:flex;"><span>                _data
</span></span><span style="display:flex;"><span>            );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Send message up to L1 bridge
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// slither-disable-next-line reentrancy-events
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            sendCrossDomainMessage(l1TokenBridge, <span style="color:#ae81ff">0</span>, message);
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// slither-disable-next-line reentrancy-events
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            emit DepositFailed(_l1Token, _l2Token, _from, _to, _amount, _data);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>The standard bridge is the most flexible mechanism for asset transfers.
However, because it is so generic it is not always the easiest mechanism to use.
Especially for withdrawals, most users prefer to use <a href="https://www.optimism.io/apps/bridges">third party bridges</a> that do not wait the challenge period and do not require a Merkle proof to finalize the withdrawal.</p>
<p>These bridges typically work by having assets on L1, which they provide immediately for a small fee (often less than the cost of gas for a standard bridge withdrawal).
When the bridge (or the people running it) anticipates being short on L1 assets it transfers sufficient assets from L2. As these are very big withdrawals, the withdrawal cost is amortized over a large amount and is a much smaller percentage.</p>
<p>Hopefully this article helped you understand more about how layer 2 works, and how to write Solidity code that is clear and secure.</p>


		
	</div>

	<div class="pagination">
		<a href="/java/rate-limit/" class="right arrow">&#8594;</a>

		<a href="#" class="top">Top</a>
	</div>
</main>


        		<footer>
			
			<span>
			&copy; <time datetime="2025-03-11 08:23:08.158496 &#43;0700 &#43;07 m=&#43;0.307977043">2025</time> Đoàn Hải. Made with <a href='https://gohugo.io'>Hugo</a> using the <a href='https://github.com/EmielH/tale-hugo/'>Tale</a> theme.
			</span>
		</footer>

    </body>
</html>
